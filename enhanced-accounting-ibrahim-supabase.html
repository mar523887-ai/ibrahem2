<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام محاسبة إبراهيم المتكامل (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .hidden {
            display: none;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full space-y-8 p-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">تسجيل الدخول</h2>
                <p class="text-gray-600">نظام محاسبة إبراهيم المتكامل</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم</label>
                    <input type="text" id="username" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="password" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div id="errorMessage" class="hidden text-red-600 text-sm text-center bg-red-50 p-3 rounded"></div>

                <button type="submit" id="loginButton" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- لوحة التحكم -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-900">نظام محاسبة إبراهيم المتكامل</h1>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <span id="userInfo" class="text-gray-700"></span>
                        <button onclick="showProfileModal()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            الملف الشخصي
                        </button>
                        <button onclick="logout()" 
                                class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="mb-8">
                <nav class="flex space-x-4 space-x-reverse mb-8">
                    <button onclick="showSection(\'dashboardSection\', this)" class="nav-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                        لوحة التحكم
                    </button>
                    <button onclick="showSection(\'warehouseSection\', this)" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        المستودع
                    </button>
                    <button onclick="showSection(\'incomingSection\', this)" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        الواردات
                    </button>
                    <button onclick="showSection(\'outgoingSection\', this)" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        الصادرات
                    </button>
                    <button onclick="showSection(\'reportsSection\', this)" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        التقارير
                    </button>
                    <button onclick="showSection(\'usersSection\', this)" id="usersTab" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        إدارة المستخدمين
                    </button>
                </nav>
            </div>

            <!-- لوحة التحكم -->
            <div id="dashboardSection" class="content-section">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">لوحة التحكم</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">إجمالي المنتجات</h3>
                        <p class="text-3xl font-bold text-blue-600" id="totalProducts">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">إجمالي الواردات</h3>
                        <p class="text-3xl font-bold text-green-600" id="totalIncoming">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">إجمالي الصادرات</h3>
                        <p class="text-3xl font-bold text-red-600" id="totalOutgoing">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">المخزون الحالي</h3>
                        <p class="text-3xl font-bold text-purple-600" id="currentStock">0</p>
                    </div>
                </div>
                
                <!-- آخر العمليات -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">آخر العمليات</h3>
                    <div id="recentActivities"></div>
                </div>
            </div>

            <!-- قسم المستودع -->
            <div id="warehouseSection" class="content-section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">إدارة المستودع</h2>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">إضافة منتج للمستودع</h3>
                    <form id="addWarehouseForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="warehouseType" class="block text-sm font-medium text-gray-700">النوع</label>
                            <input type="text" id="warehouseType" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseSize" class="block text-sm font-medium text-gray-700">المقاس</label>
                            <input type="text" id="warehouseSize" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseBrand" class="block text-sm font-medium text-gray-700">الماركة</label>
                            <input type="text" id="warehouseBrand" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseCurrentQty" class="block text-sm font-medium text-gray-700">الكمية الحالية</label>
                            <input type="number" id="warehouseCurrentQty" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseImportPrice" class="block text-sm font-medium text-gray-700">سعر الاستيراد</label>
                            <input type="number" id="warehouseImportPrice" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseSellPrice" class="block text-sm font-medium text-gray-700">سعر المبيع</label>
                            <input type="number" id="warehouseSellPrice" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseOutQty" class="block text-sm font-medium text-gray-700">الكمية الصادرة</label>
                            <input type="number" id="warehouseOutQty" value="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseDate" class="block text-sm font-medium text-gray-700">التاريخ</label>
                            <input type="date" id="warehouseDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="warehouseCurrency" class="block text-sm font-medium text-gray-700">العملة</label>
                            <select id="warehouseCurrency" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="SYP">ليرة سورية</option>
                                <option value="USD">دولار أمريكي</option>
                                <option value="TRY">ليرة تركية</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="warehouseNotes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                            <textarea id="warehouseNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">إضافة للمستودع</button>
                        </div>
                    </form>
                    <div id="warehouseMessage" class="mt-4"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">قائمة المستودع</h3>
                    <div id="warehouseList" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- قسم الواردات -->
            <div id="incomingSection" class="content-section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">إدارة الواردات</h2>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">إضافة وارد جديد</h3>
                    <form id="addIncomingForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="incomingType" class="block text-sm font-medium text-gray-700">النوع</label>
                            <input type="text" id="incomingType" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingSupplier" class="block text-sm font-medium text-gray-700">اسم المورد</label>
                            <input type="text" id="incomingSupplier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingSize" class="block text-sm font-medium text-gray-700">المقاس</label>
                            <input type="text" id="incomingSize" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingBrand" class="block text-sm font-medium text-gray-700">الماركة</label>
                            <input type="text" id="incomingBrand" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingQuantity" class="block text-sm font-medium text-gray-700">الكمية الحالية</label>
                            <input type="number" id="incomingQuantity" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingPrice" class="block text-sm font-medium text-gray-700">السعر</label>
                            <input type="number" id="incomingPrice" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingDate" class="block text-sm font-medium text-gray-700">التاريخ</label>
                            <input type="date" id="incomingDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="incomingCurrency" class="block text-sm font-medium text-gray-700">العملة</label>
                            <select id="incomingCurrency" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="SYP">ليرة سورية</option>
                                <option value="USD">دولار أمريكي</option>
                                <option value="TRY">ليرة تركية</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="incomingNotes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                            <textarea id="incomingNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">إضافة وارد</button>
                        </div>
                    </form>
                    <div id="incomingMessage" class="mt-4"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">قائمة الواردات</h3>
                    <div id="incomingList" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- قسم الصادرات -->
            <div id="outgoingSection" class="content-section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">إدارة الصادرات</h2>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">إضافة صادر جديد</h3>
                    <form id="addOutgoingForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="outgoingType" class="block text-sm font-medium text-gray-700">النوع</label>
                            <input type="text" id="outgoingType" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingBuyer" class="block text-sm font-medium text-gray-700">اسم المشتري</label>
                            <input type="text" id="outgoingBuyer" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingSize" class="block text-sm font-medium text-gray-700">المقاس</label>
                            <input type="text" id="outgoingSize" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingBrand" class="block text-sm font-medium text-gray-700">الماركة</label>
                            <input type="text" id="outgoingBrand" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingQuantity" class="block text-sm font-medium text-gray-700">الكمية الحالية</label>
                            <input type="number" id="outgoingQuantity" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingPrice" class="block text-sm font-medium text-gray-700">السعر</label>
                            <input type="number" id="outgoingPrice" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingDate" class="block text-sm font-medium text-gray-700">التاريخ</label>
                            <input type="date" id="outgoingDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="outgoingCurrency" class="block text-sm font-medium text-gray-700">العملة</label>
                            <select id="outgoingCurrency" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="SYP">ليرة سورية</option>
                                <option value="USD">دولار أمريكي</option>
                                <option value="TRY">ليرة تركية</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="outgoingNotes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                            <textarea id="outgoingNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">إضافة صادر</button>
                        </div>
                    </form>
                    <div id="outgoingMessage" class="mt-4"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">قائمة الصادرات</h3>
                    <div id="outgoingList" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- قسم التقارير -->
            <div id="reportsSection" class="content-section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">التقارير المالية</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">تقرير المبيعات</h3>
                        <div id="salesReport" class="text-gray-700"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">تقرير المشتريات</h3>
                        <div id="purchasesReport" class="text-gray-700"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">تقرير المخزون</h3>
                        <div id="inventoryReport" class="text-gray-700"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">تقرير الأرباح والخسائر</h3>
                        <div id="profitLossReport" class="text-gray-700"></div>
                    </div>
                </div>
                <button onclick="generateReports()" class="mt-6 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">توليد التقارير</button>
            </div>

            <!-- قسم إدارة المستخدمين -->
            <div id="usersSection" class="content-section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">إدارة المستخدمين</h2>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">إضافة مستخدم جديد</h3>
                    <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="newUsername" class="block text-sm font-medium text-gray-700">اسم المستخدم</label>
                            <input type="text" id="newUsername" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="newUserPassword" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                            <input type="password" id="newUserPassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700">الدور</label>
                            <select id="newUserRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="owner">المالك</option>
                                <option value="manager">المدير</option>
                                <option value="accountant">المحاسب</option>
                                <option value="dataentry">مدخل البيانات</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">إضافة مستخدم</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">قائمة المستخدمين</h3>
                    <div id="usersList" class="overflow-x-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal لتعديل المستخدم -->
    <div id="editUserModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">تعديل المستخدم</h2>
            <form id="editUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label for="editUsername" class="block text-sm font-medium text-gray-700">اسم المستخدم</label>
                    <input type="text" id="editUsername" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="editUserRole" class="block text-sm font-medium text-gray-700">الدور</label>
                    <select id="editUserRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value="owner">المالك</option>
                        <option value="manager">المدير</option>
                        <option value="accountant">المحاسب</option>
                        <option value="dataentry">مدخل البيانات</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="editUserPassword" class="block text-sm font-medium text-gray-700">كلمة المرور (اتركها فارغة لعدم التغيير)</label>
                    <input type="password" id="editUserPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="md:col-span-2 flex justify-end space-x-2 space-x-reverse">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">حفظ التغييرات</button>
                    <button type="button" onclick="closeEditUserModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل الملف الشخصي -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">الملف الشخصي</h2>
            <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="profileUsername" class="block text-sm font-medium text-gray-700">اسم المستخدم</label>
                    <input type="text" id="profileUsername" disabled class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100">
                </div>
                <div>
                    <label for="profileRole" class="block text-sm font-medium text-gray-700">الدور</label>
                    <input type="text" id="profileRole" disabled class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100">
                </div>
                <div class="md:col-span-2">
                    <label for="newPasswordProfile" class="block text-sm font-medium text-gray-700">كلمة المرور الجديدة</label>
                    <input type="password" id="newPasswordProfile" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="md:col-span-2">
                    <label for="confirmPasswordProfile" class="block text-sm font-medium text-gray-700">تأكيد كلمة المرور الجديدة</label>
                    <input type="password" id="confirmPasswordProfile" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="md:col-span-2 flex justify-end space-x-2 space-x-reverse">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">تحديث كلمة المرور</button>
                    <button type="button" onclick="closeProfileModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xyhukxqxcafttxzyfvvk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5aHVreHF4Y2FmdHR4enlmdnZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNjk4NTUsImV4cCI6MjA2OTg0NTg1NX0.WRhr_iWXv7SUjj8nXeQ4u97gCU3l21bXRPGUA9gg0PI';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let users = [];
        let warehouseItems = [];
        let incomingItems = [];
        let outgoingItems = [];

        // الدوال المساعدة
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove("hidden");
            if (isError) {
                element.classList.remove("bg-green-50", "text-green-600");
                element.classList.add("bg-red-50", "text-red-600");
            } else {
                element.classList.remove("bg-red-50", "text-red-600");
                element.classList.add("bg-green-50", "text-green-600");
            }
            setTimeout(() => {
                element.classList.add("hidden");
            }, 5000);
        }

        // وظائف المصادقة
        document.getElementById("loginForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const errorMessage = document.getElementById("errorMessage");

            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('username', username)
                .eq('password', password) // In a real app, hash passwords!
                .single();

            if (error || !data) {
                errorMessage.textContent = "اسم المستخدم أو كلمة المرور غير صحيحة.";
                errorMessage.classList.remove("hidden");
                return;
            }

            currentUser = data;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            errorMessage.classList.add("hidden");
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            updateUserInfo();
            await loadData(); // Load data after successful login
            showSection('dashboardSection', document.querySelector('.nav-btn'));
        });

        async function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById("loginScreen").classList.remove("hidden");
            document.getElementById("dashboard").classList.add("hidden");
            document.getElementById("username").value = '';
            document.getElementById("password").value = '';
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById("userInfo").textContent = `مرحباً، ${currentUser.username} (${getRoleText(currentUser.role)})`;
                // إخفاء/إظهار تبويب إدارة المستخدمين بناءً على الدور
                if (currentUser.role === 'owner') {
                    document.getElementById('usersTab').classList.remove('hidden');
                } else {
                    document.getElementById('usersTab').classList.add('hidden');
                }
            }
        }

        // وظائف تحميل وحفظ البيانات
        async function loadData() {
            // Load users
            const { data: usersData, error: usersError } = await supabase
                .from('users')
                .select('*');
            if (usersError) console.error('Error loading users:', usersError.message);
            else users = usersData || [];

            // Ensure admin user exists
            if (!users.some(u => u.username === 'admin')) {
                const { data: newAdmin, error: adminError } = await supabase
                    .from('users')
                    .insert([{ id: Date.now().toString() + Math.random().toString(36).substr(2, 9), username: 'admin', password: 'admin123', role: 'owner' }])
                    .select();
                if (adminError) console.error('Error creating admin user:', adminError.message);
                else users.push(newAdmin[0]);
            }

            // Load warehouse items
            const { data: warehouseData, error: warehouseError } = await supabase
                .from('warehouse_items')
                .select('*');
            if (warehouseError) console.error('Error loading warehouse items:', warehouseError.message);
            else warehouseItems = warehouseData || [];

            // Load incoming items
            const { data: incomingData, error: incomingError } = await supabase
                .from('incoming_items')
                .select('*');
            if (incomingError) console.error('Error loading incoming items:', incomingError.message);
            else incomingItems = incomingData || [];

            // Load outgoing items
            const { data: outgoingData, error: outgoingError } = await supabase
                .from('outgoing_items')
                .select('*');
            if (outgoingError) console.error('Error loading outgoing items:', outgoingError.message);
            else outgoingItems = outgoingData || [];

            displayAllData();
        }

        async function saveData() {
            // Data is saved directly through individual add/update/delete functions
            // This function is now primarily for re-displaying data after an operation
            displayAllData();
        }

        function displayAllData() {
            displayDashboardStats();
            displayWarehouseItems();
            displayIncomingItems();
            displayOutgoingItems();
            displayUsers();
            generateReports();
        }

        // وظائف لوحة التحكم
        function displayDashboardStats() {
            document.getElementById("totalProducts").textContent = warehouseItems.length;
            document.getElementById("totalIncoming").textContent = incomingItems.length;
            document.getElementById("totalOutgoing").textContent = outgoingItems.length;
            const currentStock = warehouseItems.reduce((sum, item) => sum + item.currentQty, 0);
            document.getElementById("currentStock").textContent = currentStock;

            let activitiesHtml = 
                `<h4 class="text-md font-semibold text-gray-800 mb-2">أحدث المنتجات المضافة</h4>` +
                `<ul class="list-disc list-inside">` +
                warehouseItems.slice(-5).reverse().map(item => `<li>${item.type} (${item.brand}) - ${item.currentQty} ${item.currency}</li>`).join('') +
                `</ul><br>` +
                `<h4 class="text-md font-semibold text-gray-800 mb-2">أحدث الواردات</h4>` +
                `<ul class="list-disc list-inside">` +
                incomingItems.slice(-5).reverse().map(item => `<li>${item.type} من ${item.supplier} - ${item.quantity} ${item.currency}</li>`).join('') +
                `</ul><br>` +
                `<h4 class="text-md font-semibold text-gray-800 mb-2">أحدث الصادرات</h4>` +
                `<ul class="list-disc list-inside">` +
                outgoingItems.slice(-5).reverse().map(item => `<li>${item.type} إلى ${item.buyer} - ${item.quantity} ${item.currency}</li>`).join('') +
                `</ul>`;
            document.getElementById("recentActivities").innerHTML = activitiesHtml;
        }

        // وظائف المستودع
        document.getElementById("addWarehouseForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const newWarehouseItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                type: document.getElementById("warehouseType").value,
                size: document.getElementById("warehouseSize").value,
                brand: document.getElementById("warehouseBrand").value,
                currentQty: parseInt(document.getElementById("warehouseCurrentQty").value),
                importPrice: parseFloat(document.getElementById("warehouseImportPrice").value),
                sellPrice: parseFloat(document.getElementById("warehouseSellPrice").value),
                outQty: parseInt(document.getElementById("warehouseOutQty").value) || 0,
                date: document.getElementById("warehouseDate").value,
                currency: document.getElementById("warehouseCurrency").value,
                notes: document.getElementById("warehouseNotes").value,
                profit: 0 // سيتم حسابه لاحقًا
            };
            newWarehouseItem.profit = (newWarehouseItem.sellPrice - newWarehouseItem.importPrice);

            const { data, error } = await supabase
                .from('warehouse_items')
                .insert([newWarehouseItem])
                .select();

            if (error) {
                showMessage('warehouseMessage', `خطأ في إضافة المنتج: ${error.message}`, true);
                console.error('Error adding warehouse item:', error.message);
            } else {
                warehouseItems.push(data[0]);
                showMessage('warehouseMessage', 'تم إضافة المنتج بنجاح!');
                document.getElementById("addWarehouseForm").reset();
                document.getElementById("warehouseDate").value = new Date().toISOString().split('T')[0];
                saveData();
            }
        });

        async function displayWarehouseItems() {
            const tableBody = document.createElement("tbody");
            warehouseItems.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.type}</td>
                    <td>${item.size}</td>
                    <td>${item.brand}</td>
                    <td>${item.currentQty}</td>
                    <td>${item.importPrice.toFixed(2)} ${item.currency}</td>
                    <td>${item.sellPrice.toFixed(2)} ${item.currency}</td>
                    <td>${item.profit.toFixed(2)} ${item.currency}</td>
                    <td>${item.outQty}</td>
                    <td>${item.date}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button onclick="editWarehouseItem('${item.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600">تعديل</button>
                        <button onclick="deleteWarehouseItem('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600">حذف</button>
                    </td>
                `;
            });

            const table = `
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>ت</th>
                            <th>النوع</th>
                            <th>المقاس</th>
                            <th>الماركة</th>
                            <th>الكمية الحالية</th>
                            <th>سعر الاستيراد</th>
                            <th>سعر المبيع</th>
                            <th>الربح</th>
                            <th>الكمية الصادرة</th>
                            <th>التاريخ</th>
                            <th>ملاحظات</th>
                            <th>العمليات</th>
                        </tr>
                    </thead>
                    ${tableBody.innerHTML}
                </table>
            `;
            document.getElementById("warehouseList").innerHTML = table;
        }

        async function editWarehouseItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            const item = warehouseItems.find(i => i.id === itemId);
            if (!item) return;

            // Populate modal fields
            document.getElementById('editWarehouseItemId').value = item.id;
            document.getElementById('editWarehouseType').value = item.type;
            document.getElementById('editWarehouseSize').value = item.size;
            document.getElementById('editWarehouseBrand').value = item.brand;
            document.getElementById('editWarehouseCurrentQty').value = item.currentQty;
            document.getElementById('editWarehouseImportPrice').value = item.importPrice;
            document.getElementById('editWarehouseSellPrice').value = item.sellPrice;
            document.getElementById('editWarehouseOutQty').value = item.outQty;
            document.getElementById('editWarehouseDate').value = item.date;
            document.getElementById('editWarehouseCurrency').value = item.currency;
            document.getElementById('editWarehouseNotes').value = item.notes;

            document.getElementById('editWarehouseModal').classList.remove('hidden');
        }

        document.getElementById("editWarehouseForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const itemId = document.getElementById('editWarehouseItemId').value;
            const updatedItem = {
                type: document.getElementById('editWarehouseType').value,
                size: document.getElementById('editWarehouseSize').value,
                brand: document.getElementById('editWarehouseBrand').value,
                currentQty: parseInt(document.getElementById('editWarehouseCurrentQty').value),
                importPrice: parseFloat(document.getElementById('editWarehouseImportPrice').value),
                sellPrice: parseFloat(document.getElementById('editWarehouseSellPrice').value),
                outQty: parseInt(document.getElementById('editWarehouseOutQty').value),
                date: document.getElementById('editWarehouseDate').value,
                currency: document.getElementById('editWarehouseCurrency').value,
                notes: document.getElementById('editWarehouseNotes').value,
            };
            updatedItem.profit = (updatedItem.sellPrice - updatedItem.importPrice);

            const { data, error } = await supabase
                .from('warehouse_items')
                .update(updatedItem)
                .eq('id', itemId)
                .select();

            if (error) {
                showMessage('warehouseMessage', `خطأ في تحديث المنتج: ${error.message}`, true);
                console.error('Error updating warehouse item:', error.message);
            } else {
                const index = warehouseItems.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    warehouseItems[index] = data[0];
                }
                showMessage('warehouseMessage', 'تم تحديث المنتج بنجاح!');
                closeEditWarehouseModal();
                saveData();
            }
        });

        async function deleteWarehouseItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            if (confirm('هل أنت متأكد من حذف هذا المنتج من المستودع؟')) {
                const { error } = await supabase
                    .from('warehouse_items')
                    .delete()
                    .eq('id', itemId);

                if (error) {
                    showMessage('warehouseMessage', `خطأ في حذف المنتج: ${error.message}`, true);
                    console.error('Error deleting warehouse item:', error.message);
                } else {
                    warehouseItems = warehouseItems.filter(item => item.id !== itemId);
                    showMessage('warehouseMessage', 'تم حذف المنتج بنجاح!');
                    saveData();
                }
            }
        }

        function closeEditWarehouseModal() {
            document.getElementById('editWarehouseModal').classList.add('hidden');
        }

        // وظائف الواردات
        document.getElementById("addIncomingForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const newIncomingItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                type: document.getElementById("incomingType").value,
                supplier: document.getElementById("incomingSupplier").value,
                size: document.getElementById("incomingSize").value,
                brand: document.getElementById("incomingBrand").value,
                quantity: parseInt(document.getElementById("incomingQuantity").value),
                price: parseFloat(document.getElementById("incomingPrice").value),
                date: document.getElementById("incomingDate").value,
                currency: document.getElementById("incomingCurrency").value,
                notes: document.getElementById("incomingNotes").value,
            };

            const { data, error } = await supabase
                .from('incoming_items')
                .insert([newIncomingItem])
                .select();

            if (error) {
                showMessage('incomingMessage', `خطأ في إضافة الوارد: ${error.message}`, true);
                console.error('Error adding incoming item:', error.message);
            } else {
                incomingItems.push(data[0]);
                showMessage('incomingMessage', 'تم إضافة الوارد بنجاح!');
                document.getElementById("addIncomingForm").reset();
                document.getElementById("incomingDate").value = new Date().toISOString().split('T')[0];
                saveData();
            }
        });

        async function displayIncomingItems() {
            const tableBody = document.createElement("tbody");
            incomingItems.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.type}</td>
                    <td>${item.supplier}</td>
                    <td>${item.size}</td>
                    <td>${item.brand}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toFixed(2)} ${item.currency}</td>
                    <td>${item.date}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button onclick="editIncomingItem('${item.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600">تعديل</button>
                        <button onclick="deleteIncomingItem('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600">حذف</button>
                    </td>
                `;
            });

            const table = `
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>ت</th>
                            <th>النوع</th>
                            <th>اسم المورد</th>
                            <th>المقاس</th>
                            <th>الماركة</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>التاريخ</th>
                            <th>ملاحظات</th>
                            <th>العمليات</th>
                        </tr>
                    </thead>
                    ${tableBody.innerHTML}
                </table>
            `;
            document.getElementById("incomingList").innerHTML = table;
        }

        async function editIncomingItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            const item = incomingItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('editIncomingItemId').value = item.id;
            document.getElementById('editIncomingType').value = item.type;
            document.getElementById('editIncomingSupplier').value = item.supplier;
            document.getElementById('editIncomingSize').value = item.size;
            document.getElementById('editIncomingBrand').value = item.brand;
            document.getElementById('editIncomingQuantity').value = item.quantity;
            document.getElementById('editIncomingPrice').value = item.price;
            document.getElementById('editIncomingDate').value = item.date;
            document.getElementById('editIncomingCurrency').value = item.currency;
            document.getElementById('editIncomingNotes').value = item.notes;

            document.getElementById('editIncomingModal').classList.remove('hidden');
        }

        document.getElementById("editIncomingForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const itemId = document.getElementById('editIncomingItemId').value;
            const updatedItem = {
                type: document.getElementById('editIncomingType').value,
                supplier: document.getElementById('editIncomingSupplier').value,
                size: document.getElementById('editIncomingSize').value,
                brand: document.getElementById('editIncomingBrand').value,
                quantity: parseInt(document.getElementById('editIncomingQuantity').value),
                price: parseFloat(document.getElementById('editIncomingPrice').value),
                date: document.getElementById('editIncomingDate').value,
                currency: document.getElementById('editIncomingCurrency').value,
                notes: document.getElementById('editIncomingNotes').value,
            };

            const { data, error } = await supabase
                .from('incoming_items')
                .update(updatedItem)
                .eq('id', itemId)
                .select();

            if (error) {
                showMessage('incomingMessage', `خطأ في تحديث الوارد: ${error.message}`, true);
                console.error('Error updating incoming item:', error.message);
            } else {
                const index = incomingItems.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    incomingItems[index] = data[0];
                }
                showMessage('incomingMessage', 'تم تحديث الوارد بنجاح!');
                closeEditIncomingModal();
                saveData();
            }
        });

        async function deleteIncomingItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            if (confirm('هل أنت متأكد من حذف هذا الوارد؟')) {
                const { error } = await supabase
                    .from('incoming_items')
                    .delete()
                    .eq('id', itemId);

                if (error) {
                    showMessage('incomingMessage', `خطأ في حذف الوارد: ${error.message}`, true);
                    console.error('Error deleting incoming item:', error.message);
                } else {
                    incomingItems = incomingItems.filter(item => item.id !== itemId);
                    showMessage('incomingMessage', 'تم حذف الوارد بنجاح!');
                    saveData();
                }
            }
        }

        function closeEditIncomingModal() {
            document.getElementById('editIncomingModal').classList.add('hidden');
        }

        // وظائف الصادرات
        document.getElementById("addOutgoingForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const newOutgoingItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                type: document.getElementById("outgoingType").value,
                buyer: document.getElementById("outgoingBuyer").value,
                size: document.getElementById("outgoingSize").value,
                brand: document.getElementById("outgoingBrand").value,
                quantity: parseInt(document.getElementById("outgoingQuantity").value),
                price: parseFloat(document.getElementById("outgoingPrice").value),
                date: document.getElementById("outgoingDate").value,
                currency: document.getElementById("outgoingCurrency").value,
                notes: document.getElementById("outgoingNotes").value,
            };

            const { data, error } = await supabase
                .from('outgoing_items')
                .insert([newOutgoingItem])
                .select();

            if (error) {
                showMessage('outgoingMessage', `خطأ في إضافة الصادر: ${error.message}`, true);
                console.error('Error adding outgoing item:', error.message);
            } else {
                outgoingItems.push(data[0]);
                showMessage('outgoingMessage', 'تم إضافة الصادر بنجاح!');
                document.getElementById("addOutgoingForm").reset();
                document.getElementById("outgoingDate").value = new Date().toISOString().split('T')[0];
                saveData();
            }
        });

        async function displayOutgoingItems() {
            const tableBody = document.createElement("tbody");
            outgoingItems.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.type}</td>
                    <td>${item.buyer}</td>
                    <td>${item.size}</td>
                    <td>${item.brand}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toFixed(2)} ${item.currency}</td>
                    <td>${item.date}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button onclick="editOutgoingItem('${item.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600">تعديل</button>
                        <button onclick="deleteOutgoingItem('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600">حذف</button>
                    </td>
                `;
            });

            const table = `
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>ت</th>
                            <th>النوع</th>
                            <th>اسم المشتري</th>
                            <th>المقاس</th>
                            <th>الماركة</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>التاريخ</th>
                            <th>ملاحظات</th>
                            <th>العمليات</th>
                        </tr>
                    </thead>
                    ${tableBody.innerHTML}
                </table>
            `;
            document.getElementById("outgoingList").innerHTML = table;
        }

        async function editOutgoingItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            const item = outgoingItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('editOutgoingItemId').value = item.id;
            document.getElementById('editOutgoingType').value = item.type;
            document.getElementById('editOutgoingBuyer').value = item.buyer;
            document.getElementById('editOutgoingSize').value = item.size;
            document.getElementById('editOutgoingBrand').value = item.brand;
            document.getElementById('editOutgoingQuantity').value = item.quantity;
            document.getElementById('editOutgoingPrice').value = item.price;
            document.getElementById('editOutgoingDate').value = item.date;
            document.getElementById('editOutgoingCurrency').value = item.currency;
            document.getElementById('editOutgoingNotes').value = item.notes;

            document.getElementById('editOutgoingModal').classList.remove('hidden');
        }

        document.getElementById("editOutgoingForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner', 'manager', 'dataentry')) return;

            const itemId = document.getElementById('editOutgoingItemId').value;
            const updatedItem = {
                type: document.getElementById('editOutgoingType').value,
                buyer: document.getElementById('editOutgoingBuyer').value,
                size: document.getElementById('editOutgoingSize').value,
                brand: document.getElementById('editOutgoingBrand').value,
                quantity: parseInt(document.getElementById('editOutgoingQuantity').value),
                price: parseFloat(document.getElementById('editOutgoingPrice').value),
                date: document.getElementById('editOutgoingDate').value,
                currency: document.getElementById('editOutgoingCurrency').value,
                notes: document.getElementById('editOutgoingNotes').value,
            };

            const { data, error } = await supabase
                .from('outgoing_items')
                .update(updatedItem)
                .eq('id', itemId)
                .select();

            if (error) {
                showMessage('outgoingMessage', `خطأ في تحديث الصادر: ${error.message}`, true);
                console.error('Error updating outgoing item:', error.message);
            } else {
                const index = outgoingItems.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    outgoingItems[index] = data[0];
                }
                showMessage('outgoingMessage', 'تم تحديث الصادر بنجاح!');
                closeEditOutgoingModal();
                saveData();
            }
        });

        async function deleteOutgoingItem(itemId) {
            if (!checkPermission('owner', 'manager', 'dataentry')) return;
            if (confirm('هل أنت متأكد من حذف هذا الصادر؟')) {
                const { error } = await supabase
                    .from('outgoing_items')
                    .delete()
                    .eq('id', itemId);

                if (error) {
                    showMessage('outgoingMessage', `خطأ في حذف الصادر: ${error.message}`, true);
                    console.error('Error deleting outgoing item:', error.message);
                } else {
                    outgoingItems = outgoingItems.filter(item => item.id !== itemId);
                    showMessage('outgoingMessage', 'تم حذف الصادر بنجاح!');
                    saveData();
                }
            }
        }

        function closeEditOutgoingModal() {
            document.getElementById('editOutgoingModal').classList.add('hidden');
        }

        // وظائف إدارة المستخدمين
        document.getElementById("addUserForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner')) return;

            const newUserData = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                username: document.getElementById("newUsername").value,
                password: document.getElementById("newUserPassword").value,
                role: document.getElementById("newUserRole").value,
            };

            const { data, error } = await supabase
                .from('users')
                .insert([newUserData])
                .select();

            if (error) {
                showMessage('usersSection', `خطأ في إضافة المستخدم: ${error.message}`, true);
                console.error('Error adding user:', error.message);
            } else {
                users.push(data[0]);
                showMessage('usersSection', 'تم إضافة المستخدم بنجاح!');
                document.getElementById("addUserForm").reset();
                saveData();
            }
        });

        async function displayUsers() {
            const tableBody = document.createElement("tbody");
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${getRoleText(user.role)}</td>
                    <td>
                        <button onclick="editUser('${user.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600">تعديل</button>
                        <button onclick="deleteUser('${user.id}')" class="bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600">حذف</button>
                    </td>
                `;
            });

            const table = `
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>ت</th>
                            <th>اسم المستخدم</th>
                            <th>الدور</th>
                            <th>العمليات</th>
                        </tr>
                    </thead>
                    ${tableBody.innerHTML}
                </table>
            `;
            document.getElementById("usersList").innerHTML = table;
        }

        async function editUser(userId) {
            if (!checkPermission('owner')) return;
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserPassword').value = '';
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        document.getElementById("editUserForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            if (!checkPermission('owner')) return;

            const userId = document.getElementById('editUserId').value;
            const username = document.getElementById('editUsername').value;
            const role = document.getElementById('editUserRole').value;
            const password = document.getElementById('editUserPassword').value;
            
            const updatedUserData = {
                username: username,
                role: role,
            };
            if (password) {
                updatedUserData.password = password;
            }

            const { data, error } = await supabase
                .from('users')
                .update(updatedUserData)
                .eq('id', userId)
                .select();

            if (error) {
                showMessage('usersSection', `خطأ في تحديث المستخدم: ${error.message}`, true);
                console.error('Error updating user:', error.message);
            } else {
                const index = users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    users[index] = data[0];
                }
                showMessage('usersSection', 'تم تحديث المستخدم بنجاح!');
                closeEditUserModal();
                saveData();
            }
        });

        async function deleteUser(userId) {
            if (!checkPermission('owner')) return;
            const user = users.find(u => u.id === userId);
            if (user && user.username === 'admin') {
                alert('لا يمكن حذف المستخدم الرئيسي');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) {
                    showMessage('usersSection', `خطأ في حذف المستخدم: ${error.message}`, true);
                    console.error('Error deleting user:', error.message);
                } else {
                    users = users.filter(u => u.id !== userId);
                    showMessage('usersSection', 'تم حذف المستخدم بنجاح!');
                    saveData();
                }
            }
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
        }

        // عرض modal الملف الشخصي
        function showProfileModal() {
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileRole').value = getRoleText(currentUser.role);
            document.getElementById('newPasswordProfile').value = '';
            document.getElementById('confirmPasswordProfile').value = '';
            
            document.getElementById('profileModal').classList.remove('hidden');
        }

        // إغلاق modal الملف الشخصي
        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        // تحديث كلمة المرور
        document.getElementById("profileForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const newPassword = document.getElementById('newPasswordProfile').value;
            const confirmPassword = document.getElementById('confirmPasswordProfile').value;
            
            if (!newPassword) {
                alert('يرجى إدخال كلمة المرور الجديدة');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('كلمات المرور غير متطابقة');
                return;
            }
            
            const { data, error } = await supabase
                .from('users')
                .update({ password: newPassword })
                .eq('id', currentUser.id)
                .select();

            if (error) {
                alert(`خطأ في تحديث كلمة المرور: ${error.message}`);
                console.error('Error updating password:', error.message);
            } else {
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Update local storage as well
                alert('تم تحديث كلمة المرور بنجاح');
                closeProfileModal();
            }
        });

        // توليد التقارير
        function generateReports() {
            // تقرير المبيعات
            const totalSales = outgoingItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('salesReport').innerHTML = `
                <p><strong>إجمالي المبيعات:</strong> ${totalSales.toFixed(2)}</p>
                <p><strong>عدد العمليات:</strong> ${outgoingItems.length}</p>
            `;
            
            // تقرير المشتريات
            const totalPurchases = incomingItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('purchasesReport').innerHTML = `
                <p><strong>إجمالي المشتريات:</strong> ${totalPurchases.toFixed(2)}</p>
                <p><strong>عدد العمليات:</strong> ${incomingItems.length}</p>
            `;
            
            // تقرير المخزون
            const totalStock = warehouseItems.reduce((sum, item) => sum + item.currentQty, 0);
            const stockValue = warehouseItems.reduce((sum, item) => sum + (item.sellPrice * item.currentQty), 0);
            document.getElementById('inventoryReport').innerHTML = `
                <p><strong>إجمالي الكمية:</strong> ${totalStock}</p>
                <p><strong>قيمة المخزون:</strong> ${stockValue.toFixed(2)}</p>
            `;
            
            // تقرير الأرباح والخسائر
            const totalProfit = warehouseItems.reduce((sum, item) => sum + (item.profit * item.outQty), 0);
            document.getElementById('profitLossReport').innerHTML = `
                <p><strong>إجمالي الأرباح:</strong> ${totalProfit.toFixed(2)}</p>
                <p><strong>معدل الربح:</strong> ${totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(2) : 0}%</p>
            `;
        }

        // دوال مساعدة
        function getRoleText(role) {
            const roles = {
                'owner': 'المالك',
                'manager': 'المدير',
                'accountant': 'المحاسب',
                'dataentry': 'مدخل البيانات'
            };
            return roles[role] || role;
        }

        function getCurrencyText(currency) {
            const currencies = {
                'SYP': 'ليرة سورية',
                'USD': 'دولار أمريكي',
                'TRY': 'ليرة تركية'
            };
            return currencies[currency] || currency;
        }

        function checkPermission(...allowedRoles) {
            if (!currentUser) {
                alert('يرجى تسجيل الدخول أولاً.');
                return false;
            }
            if (!allowedRoles.includes(currentUser.role)) {
                alert('ليس لديك الصلاحية للقيام بهذا الإجراء.');
                return false;
            }
            return true;
        }

        // دوال التنقل بين الأقسام
        function showSection(sectionId, button) {
            // إخفاء جميع الأقسام
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // إظهار القسم المطلوب
            document.getElementById(sectionId).classList.remove('hidden');
            
            // تحديث أزرار التنقل
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // تفعيل الزر المحدد
            button.classList.remove('border-transparent', 'text-gray-500');
            button.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
        }

        // Initial load and display
        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('warehouseDate').value = today;
            document.getElementById('incomingDate').value = today;
            document.getElementById('outgoingDate').value = today;

            // Try to load current user from localStorage
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById("loginScreen").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                updateUserInfo();
                await loadData();
                showSection('dashboardSection', document.querySelector('.nav-btn'));
            }
        });

    </script>
</body>
</html>


